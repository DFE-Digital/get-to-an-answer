@using System.Globalization
@using System.Security.Claims
@using Admin.Pages.Preview
@using Common.Models.ViewModels
@using Common.Configuration
@using Common.Domain
@using Common.Extensions
@using Admin.Pages.Questionnaire
@using Joonasw.AspNetCore.SecurityHeaders.Csp
@using Microsoft.AspNetCore.Http.Features
@using Microsoft.Extensions.Options

@inject IWebHostEnvironment WebHostEnvironment
@inject ICspNonceService CspNonceService
@inject IOptions<ScriptOptions> ScriptOptions

@{
    var scriptConfig = ScriptOptions.Value;
    var consentFeature = Context.Features.Get<ITrackingConsentFeature>() ?? throw new NullReferenceException();
    
    var languageCode = Context.Request.RouteValues["languageCode"]?.ToString();
    if (string.IsNullOrEmpty(languageCode))
    {
        languageCode = "en";
    }

    ViewBag.FullName = User.FindFirst(ClaimTypes.Name)?.Value ??
                       User.FindFirst("name")?.Value;

    var configViewModel = new ConfigViewModel();
    
    ViewBag.IsPreview = true;
}

<!DOCTYPE html>
<html class="@(SiteConfiguration.Rebrand ? "govuk-template--rebranded" : "govuk-template")
    @(Model.IsEmbedded ? "govuk-no-scroll" : "")" lang="@languageCode">

<head>
    <meta charset="utf-8"/>
    @if (WebHostEnvironment.IsProduction())
    {
        <script async="" src="//www.google-analytics.com/analytics.js" asp-add-nonce="true"></script>
        <script type="text/javascript" async="" src="https://www.googletagmanager.com/gtag/js?id=G-FL1KXJXLLP&amp;cx=c&amp;gtm=4e61q1" asp-add-nonce="true"></script>
        <script type="text/javascript" async="" src="https://www.googletagmanager.com/gtm.js?id=GTM-NR85VLDG&amp;gtm=4e61q1" asp-add-nonce="true"></script>
        <script async="" src="https://scripts.clarity.ms/0.8.51/clarity.js" asp-add-nonce="true"></script>
        <script async="" src="https://www.clarity.ms/tag/ueriupdhuw" asp-add-nonce="true"></script>
        <script async="" src="https://www.googletagmanager.com/gtm.js?id=GTM-M2CBTMTD" asp-add-nonce="true"></script>

        <script asp-add-nonce="true" type="text/javascript">
            (function(c,l,a,r,i,t,y){
                c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
                t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
                y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
            })(window, document, "clarity", "script", "ueriupdhuw");

            (function () {
                window.clarity('consent', @(consentFeature.CanTrack.ToString().ToLower()));
            }());
        </script>
    
        <script asp-add-nonce="true">
            // Define dataLayer and the gtag function.
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}

            // Set default consent to 'denied' as a placeholder
            // Determine actual values based on your own requirements
            gtag('consent', 'default', {
                'ad_storage': 'denied',
                'ad_user_data': 'denied',
                'ad_personalization': 'denied',
                'analytics_storage': 'denied',
            });
        </script>

        <!-- Google Tag Manager -->
        <script asp-add-nonce="true">
            (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});
                var f=d.getElementsByTagName(s)[0],
                    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;
                j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;
                j.setAttribute('nonce','@CspNonceService.GetNonce()');
                f.parentNode.insertBefore(j,f);
            })(window,document,'script','dataLayer','GTM-M2CBTMTD');</script>
        <!-- End Google Tag Manager -->
    }
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>@ViewData["Title"]</title>
    <style asp-add-nonce="true">
        :root {
            --generated: '@DateTime.Today.ToString("d MMMM yyyy", DateTimeFormatInfo.InvariantInfo)' ;
        }
    </style>
    @if (SiteConfiguration.Rebrand)
    {
        <link rel="icon" sizes="48x48" href="/assets/rebrand/images/favicon.ico" asp-append-version="false"/>
        <link rel="icon" sizes="any" type="image/svg+xml" href="/assets/rebrand/images/favicon.svg" asp-append-version="false"/>
        <link rel="mask-icon" href="/assets/rebrand/images/govuk-icon-mask.svg" color="#0b0c0c" asp-append-version="false"/>
        <link rel="apple-touch-icon" sizes="180x180" href="/assets/rebrand/images/govuk-icon-180.png" asp-append-version="false"/>
        <link rel="manifest" href="/assets/rebrand/manifest.json">
    }
    else
    {
        <link rel="icon" sizes="48x48" href="/assets/images/favicon.ico" asp-append-version="false"/>
        <link rel="icon" sizes="any" type="image/svg+xml" href="/assets/images/favicon.svg" asp-append-version="false"/>
        <link rel="mask-icon" href="/assets/images/govuk-icon-mask.svg" color="#0b0c0c" asp-append-version="false"/>
        <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/govuk-icon-180.png" asp-append-version="false"/>
        <link rel="manifest" href="/assets/manifest.json">
    }

    <meta name="apple-mobile-web-app-title" content="checker" />

    <link rel="stylesheet" href="~/css/application.css" asp-append-version="false"/>
    <link rel="stylesheet" href="~/css/print.css" asp-append-version="false"/>
    @if (SiteConfiguration.Rebrand)
    {
        <link rel="stylesheet" href="~/css/rebrand.css" asp-append-version="false"/>
    }

    @if (IsSectionDefined("Head")) {
        @await RenderSectionAsync("Head", required: false)
    }
    
    @if (Model is QuestionnaireNext or QuestionnaireStart)
    {
        var questionnaire = Model?.Questionnaire as QuestionnaireInfoDto;
        var hintColor = questionnaire?.TextColor.ToHintTextColor();
        var buttonHoverColor = questionnaire?.PrimaryButtonColor.ToHoverColor();
        var errorHoverColor = questionnaire?.ErrorMessageColor.ToHoverColor();
        var buttonShadowColor = questionnaire?.PrimaryButtonColor.ToShadowColor();

        <style>
        .govuk-button {
            background-color: @Model?.Questionnaire.PrimaryButtonColor;
            box-shadow: 0 2px 0 @buttonShadowColor;
        }
        .govuk-button:hover {
            background-color: @buttonHoverColor;
        }
        .govuk-button:focus, .govuk-radios__input:focus, .govuk-checkboxes__input:focus {
            border-color: @Model?.Questionnaire.StateColor !important;
        }
        .govuk-select:focus {
            outline-color: @Model?.Questionnaire.StateColor !important;
        }
        h1, h2, h3, h4, h5, h6, p, label, .govuk-body {
            color: @Model?.Questionnaire.TextColor !important;
        }
        .govuk-hint {
            color: @hintColor !important;
            .govuk-body {
                color: @hintColor !important;
            }
        }
        .govuk-template__body {
          background-color: @Model?.Questionnaire.BackgroundColor !important;
        }
        .govuk-error-summary {
            border: 5px solid @Model?.Questionnaire.ErrorMessageColor;
        }
        .govuk-error-summary__list a:link {
            color: @Model?.Questionnaire.ErrorMessageColor;
        }
        .govuk-form-group--error {
            border-left: 5px solid @Model?.Questionnaire.ErrorMessageColor;
        }
        .govuk-error-message {
            color: @Model?.Questionnaire.ErrorMessageColor !important;
        }
        .govuk-error-summary__list a:hover {
            color: @errorHoverColor !important;
        }
        .govuk-error-summary__list a:focus {
            color: @Model?.Questionnaire.TextColor !important;
        }
        </style>
    }
</head>

<body class="govuk-template__body">
<!-- Google Tag Manager (noscript) -->
<noscript>
    <iframe title="GTM" src="https://www.googletagmanager.com/ns.html?id=GTM-M2CBTMTD"
            height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
<script asp-add-nonce="true">
    document.body.className += ' js-enabled' + ('noModule' in HTMLScriptElement.prototype ? ' govuk-frontend-supported' : '');
</script>

<a href="#main-content" class="govuk-skip-link" data-module="govuk-skip-link">Skip to main content</a>
@{
    if (!Model.IsEmbedded)
    {
        await Html.RenderPartialAsync("_Header", configViewModel);
    }
}

@if (!Model.IsEmbedded)
{
    <div class="govuk-service-navigation app-service-navigation" data-module="govuk-service-navigation" data-govuk-service-navigation-init="">
        <div class="govuk-width-container">
            <div class="govuk-service-navigation__container">
                <span class="govuk-service-navigation__service-name">
                    <a href="/" class="govuk-service-navigation__link">
                        @configViewModel.ServiceDisplayName
                    </a>
                </span>
                <nav aria-label="Menu" class="govuk-service-navigation__wrapper">
                    <button type="button" class="govuk-service-navigation__toggle govuk-js-service-navigation-toggle" aria-controls="navigation" hidden="">Menu</button>
                    <ul id="navigation" class="govuk-service-navigation__list">
                        <li class="govuk-service-navigation__item">
                            <a class="govuk-service-navigation__link" aria-current="true" href="/support">Support</a>
                        </li>
                        <li class="govuk-service-navigation__item app-service-navigation__item--featured">
                            <span class="govuk-service-navigation__text">@ViewBag.FullName</span>
                        </li>

                        @if (User?.Identity?.IsAuthenticated == true)
                        {
                            <li class="govuk-service-navigation__item">
                                <a class="govuk-service-navigation__link" aria-current="true" asp-area="MicrosoftIdentity" asp-controller="Account" asp-action="SignOut">Sign out</a>
                            </li>
                        }
                    </ul>
                </nav>
            </div>
        </div>
    </div>
}

@if (IsSectionDefined("BeforeGDSContent"))

{
    <section class="dfe-page-grey" id="main-content-header">
        <div class="govuk-width-container" id="main-header-container">
            @await RenderSectionAsync("BeforeGDSContent", required: false)
        </div>
    </section>
}

@await RenderSectionAsync("BeforeContainer", required: false)
<div class="govuk-width-container @ViewBag.ContainerClasses" id="main-content-container">
    @await RenderSectionAsync("BeforeContent", required: false)

    <main class="govuk-main-wrapper @ViewBag.MainClasses" id="main-content" role="main" lang="@ViewBag.MainLang">
        @RenderBody()
    </main>
</div>
@if (IsSectionDefined("AfterGDSContent"))
{
    <section class="dfe-page-grey" id="main-content-footer">
        <div class="govuk-width-container">
            @await RenderSectionAsync("AfterGDSContent")
        </div>
    </section>
}

@{
    if (!Model.IsEmbedded)
    {
        await Html.RenderPartialAsync("_Footer", configViewModel);
    }
}

@await RenderSectionAsync("Scripts", false)
<script asp-add-nonce="true" src="/js/dfefrontend.min.js"></script>
</body>

</html>