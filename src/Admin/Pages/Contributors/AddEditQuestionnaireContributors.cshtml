@page "/admin/questionnaires/{questionnaireId:guid}/contributors"
@using Admin.Models
@using Common.Models
@model Admin.Pages.Contributors.AddEditQuestionnaireContributors

@{
  Layout = "_Layout";
  ViewData["Title"] = "Manage access";
}

@section BeforeContent
{
  <a class="govuk-back-link govuk-!-display-none-print" href="@Model?.BackLinkSlug">Back</a>
}

@if (Model!.HasErrors())
{
  @await Html.PartialAsync("_ErrorSummary")
}

@if (Model.QuestionnaireState is { JustAddedContributor: true })
{
<div class="govuk-grid-row">
  <div class="govuk-grid-column-two-thirds">
    <div class="govuk-notification-banner govuk-notification-banner--success" role="alert" aria-labelledby="govuk-notification-banner-title" data-module="govuk-notification-banner">
      <div class="govuk-notification-banner__header">
        <h2 class="govuk-notification-banner__title" id="govuk-notification-banner-title">
          Success
        </h2>
      </div>
      <div class="govuk-notification-banner__content">
        <h3 id="just-saved-access-changes-banner-text" class="govuk-notification-banner__heading">
          @Model.QuestionnaireState.ContributorEmail has been given access
        </h3>
      </div>
    </div>
  </div>
</div>
}

<div class="govuk-grid-row">
  <div class="govuk-grid-column-two-thirds">
    <h1 id="manage-access-title" class="govuk-heading-l govuk-!-margin-bottom-2">
      <span id="current-questionnaire-title" class="govuk-caption-l">@Model.QuestionnaireTitle</span>
      @ViewData["Title"]
    </h1>
    <div id="manage-access-hint" class="govuk-hint govuk-!-margin-bottom-8">
      <p>It's recommended that at least 2 people have access to a questionnaire to make sure it can be maintained.</p>

      <p>The following people have access to view or edit this questionnaire. </p>
    </div>
    
    <div class="app-page-list">
      @if (Model.Contributors is { } contributors)
      {
        var contributorCount = contributors.Count;
        var canDeleteContributors = contributorCount > 2;
        
        <table class="govuk-table">
          <thead class="govuk-table__head">
          <tr class="govuk-table__row">
            <th scope="col" class="govuk-table__header">Name</th>
            <th scope="col" class="govuk-table__header">Email address</th>
            <th scope="col" class="govuk-table__header"> </th>
          </tr>
          </thead>
          <tbody class="govuk-table__body">
          @for (var index = 0; index < contributors.Count; index++)
          {
            var contributor = contributors[index];
            var row = index + 1;
            
            <tr class="govuk-table__row govuk-table__row-v-centered">
              <td class="govuk-table__cell">@contributor.DisplayName</td>
              <td class="govuk-table__cell">@contributor.UserPrincipalName</td>
              <td class="govuk-table__cell">
                <form method="post">
                  <input type="hidden" asp-for="@Model.BackLinkSlug" />
                  <input type="hidden" name="ContributorEmail" value="@contributor.UserPrincipalName"/>
                  <input type="hidden" name="ContributorId" value="@contributor.Id"/>

                  @if (canDeleteContributors)
                  {
                    <button id="remove-contributor-@row" class="govuk-button govuk-button--warning" data-module="govuk-button" type="submit"
                            asp-page-handler="DeleteContributor">Remove</button>
                  }
                </form>
              </td>
            </tr>
          }
          </tbody>
        </table>
      }
    </div>
    <div class="govuk-button-group">
      <a id="add-person" class="govuk-button govuk-!-margin-bottom-3 govuk-!-margin-top-3" data-module="govuk-button" 
         href="@string.Format(Routes.AddContributor, Model.QuestionnaireId)">Add person</a>
    </div>
  </div>
</div>